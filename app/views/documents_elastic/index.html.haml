.container.py-4
  .row.mb-4
    .col-md-8
      %h1.mb-3 Hybrid Keyword Search

    / ----------------------------------------------------
    / INFO ACCORDION — FOR NON-TECH USERS
    / ----------------------------------------------------
    .accordion.mb-4#infoAccordion
      .accordion-item
        %h2.accordion-header#infoHeading
          %button.accordion-button.collapsed{ type: "button", data: { bs_toggle: "collapse", bs_target: "#infoCollapse" }, aria: { expanded: "false", controls: "infoCollapse" }}
            How does hybrid keyword search work?

        .accordion-collapse.collapse#infoCollapse{
          aria: { labelledby: "infoHeading" },
          data: { bs_parent: "#infoAccordion" }
        }
          .accordion-body
            %p
              Hybrid keyword search combines two kinds of relevance signals:
            %ul
              %li
                %strong 1. Text relevance (BM25):
                Based on how well a document’s text matches the query’s text.
              %li
                %strong 2. Writing-style keyword similarity:
                Every document is assigned descriptive style keywords
                (e.g. “dense”, “easy-to-read”, “subjective”, “varied-vocabulary”).
                We look for documents whose style keywords overlap with the query’s style.
              %li
                %strong 3. Hybrid score:
                Both scores are merged using the percentage slider.
                A higher percentage means writing-style keywords have more influence.

            %p.mt-2
              The results below show:
            %ul
              %li BM25 score (text relevance)
              %li Keyword similarity score (style similarity)
              %li Final hybrid score (combined)
              %li All style keywords assigned to each document

            = link_to "Download TREC Results", export_trec_documents_elastic_index_path, class: "btn btn-success my-3"


  / ----------------------------------------------------
  / SEARCH FORM
  / ----------------------------------------------------
  .row.mb-4
    .col-md-8
      = form_with url: documents_elastic_index_path, method: :get, local: true, class: "row g-3" do |f|

        .col-md-6
          = f.label :query_id, "Select Query"
          = f.select :query_id,
              @queries.map { |q| ["#{q.trec_id} – #{q.title.truncate(50)}", q.id] },
              { include_blank: "Choose query…" },
              class: "form-select"

        .col-md-4
          = f.label :weight, "Keyword weight (%)"
          = f.number_field :weight,
              value: @weight,
              min: 0,
              max: 100,
              step: 5,
              class: "form-control"

        .col-md-2.d-flex.align-items-end
          = f.submit "Search", class: "btn btn-primary w-100"

  / ----------------------------------------------------
  / SEARCH SUMMARY
  / ----------------------------------------------------

  - if @searched
    %h5.mt-3.mb-3
      Results for query:
      %strong= @query_doc.trec_id

    %p.text-muted= @query_doc.body.truncate(300)
    %p.mt-2
      %strong Query Style Keywords:
      - @query_doc.style_keywords.each do |kw|
        %span.badge.bg-light.text-dark.border.mx-1= kw
    %p.badge.bg-secondary.mt-2= "#{@documents.size} results"

  - else
    %h5.mt-3.mb-3.text-muted
      Showing 20 random documents

  / ----------------------------------------------------
  / RESULTS LIST
  / ----------------------------------------------------

  - if @documents.any?
    .list-group.mt-3
      - @documents.each do |doc|
        .list-group-item
          %h5.mb-1= doc.title.presence || "Untitled Document"
          %small.text-muted
            Record ID: #{doc.trec_id}

          - if @searched
            %div.mt-2
              %span.badge.bg-info.text-dark
                BM25 Score: #{doc.norm_bm25.round(3)}

              %span.badge.bg-warning.text-dark
                Keyword Score: #{(doc.keyword_score || 0).round(3)}

              %span.badge.bg-success.text-dark
                Hybrid Score: #{(doc.hybrid_score || 0).round(3)}

            / STYLE KEYWORD LIST
            - if doc.style_keywords.present?
              %div.mt-2
                %strong Style keywords:
                - doc.style_keywords.each do |kw|
                  %span.badge.bg-light.text-dark.border.mx-1= kw

          %p.mt-2.mb-1
            = truncate(doc.body, length: 500)

  - else
    .alert.alert-info No documents found.
